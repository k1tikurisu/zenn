---
title: "（仮）TypeScript 5.5 Betaで入った正規表現リテラルの構文チェックについて調べてみた"
emoji: "*️⃣"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["TypeScript", "正規表現"]
published: false
publication_name: "cybozu_frontend"
---

TypeScript 5.5 Betaで、正規表現リテラルの構文チェックが導入されました。

https://devblogs.microsoft.com/typescript/announcing-typescript-5-5-beta/#regular-expression-syntax-checking

JavaScriptの実行時エラーになりうる正規表現の構文に対して、事前にTypeScriptがエラーを出力してくれるようになります。

この機能について、なんで導入されたのか、JavaScriptで実行できるけどTypeScriptでエラーになる構文があるのか、ESLintとのカバー範囲の違いは？など色々気になったので調べてみました。

## TypeScriptの正規表現チェックはなぜ導入されたのか

正規表現の構文チェックがあると嬉しいよねみたいなIssueは2014年ごろに立てられています。

https://github.com/microsoft/TypeScript/issues/3432

同年に何個かPRも出ています。`RegExp`コンストラクタに正規表現リテラルを突っ込んで、エラーになったらエラー文を出すというものです。

https://github.com/microsoft/TypeScript/pull/4387

ただ、この方法だと実行エンジンによってエラーになったりならなかったり、Node.js v8で動かなかったり、`RegExp`が吐くエラーはプラットフォーム固有なので、翻訳できない、など色々問題がありクローズされています。

https://github.com/microsoft/TypeScript/pull/4387#issuecomment-135139984

> It's not that i'm not sure. It's that I think the fix isn't correct. You're fix says "if the engine the TS compiler is running in doesn't like the Regex, then the Regex is bad". But that's not the case. You may end up running your regex in an environment that thinks the regex is fine.
> Now, if you wanted to go more the distance and actually check specific parts of the string against the regex grammar in the ES6 specification, then I would be more ok with that :)

クローズされた時のコメントでは、修正方法がよくないだけで、ECMAScriptの仕様に準拠して構文チェックするなら良さそうみたいなことが書かれています。今まで放置されていたのは、特に理由があるというわけではなさそうで、やる人がいなかったのかなと思いました。また、5.5 BetaでマージされたものはだいたいECMAScriptの仕様に準拠しているんだろうなと予想できます。

## 実際どんな感じでチェックしている？

マージされたPRは下記で、この後もいろいろ追従してPRが出ていますが、一旦これを読んでいきます。

https://github.com/microsoft/TypeScript/pull/55600

PRを読むと、正規表現の構文チェックは、Scannerで実装されていることがわかります。Scannerとは、[Scanner | TypeScript Deep Dive](https://basarat.gitbook.io/typescript/overview/scanner)にわかりやすく書かれています。ソースコードは、Scannerを経由してToken Streamになり、その後Parserを通してASTに変換されるようです。

つまり、トークン単位でソースコードをスキャンしていき、`/`か`/=`が出てきたら正規表現として、さらに中身を読んでいき、特定のパターンをチェックして弾くようなイメージで実装されています。

https://github.com/microsoft/TypeScript/blob/b1c52c53cc6c8cf35b19accfc3e29916489c821e/src/compiler/scanner.ts#L2450-L2451

レビューでは、Scannerではなくて、Parserで構文チェックのロジックを持った方がのちにASTノードを追加して詳細な解析ができるようになって良さそうみたいなコメントもあったようですが、パフォーマンスの懸念が優先されたようです。

マージコメントでは、のちにParserに移動されるようなことが書かれていました。

## どういう構文をカバーしている？　TODO

冒頭のリンクのアナウンスメントには、TypeScriptでは基本的な正規表現の構文チェックが実行されるようになったこと、存在しない後方参照や、存在しない名前付きキャプチャグループの参照もエラーにできるよ、ターゲットバージョンよりも新しい構文を使ってたらエラーにするよ、構文チェックするのは正規表現リテラルだけだよみたいなことが書かれています。

## GitHubの主要リポジトリにおける正規表現チェックの影響を見てみる

下記のIssueでは、TSを使用した800のリポジトリに対して、5.4.5ではエラーにならず、Betaでエラーになったものの一部をキャプチャしています。

https://github.com/microsoft/TypeScript/issues/58287

かなり大量のエラーが検出されていることがわかりますが、基本的にはTypeScriptのコンパイラオプションのECMAScriptのターゲットが古いことに起因するもので、それ以外はレガシー構文（Annex B）によるものだと書かれています。まだ議論されているようですが、ECMAScriptのAnnex Bに記載されている正規表現の構文は、理解して使っているなら`@ts-ignore`してね、ということになりそうです。のちにコンパイラオプションなどでフラグによって制御できるようにしたいみたいに書かれています。

具体医的には、下記のような構文は今うまいこと動いていても、TypeScriptではエラーになります。

```md
<!-- ## ESLintとのカバー範囲の違い

ESLintはデフォルトパーサにEspreeを使用しており、EspreeはAcornに依存しています。AcornはECMAScript仕様に準拠しているため、ESLintは基本的にECMAScript仕様に準拠した正規表現のパースを行うと言えそうです。ESLintはその上で、ルールやプラグインによって拡張することができます。

ESLintの正規表現に関連する各種ルールには、ECMAScript準拠の正規表現パーサである regexpp が使用されています。

https://github.com/eslint-community/regexpp

これは、正規表現からESTreeよりも細かい単位のASTにパースし、細かい解析が可能になるというものです。

ESLintの正規表現プラグインである、[eslint-plugin-regexp](https://github.com/ota-meshi/eslint-plugin-regexp)でもがっつり使用されています。eslint-plugin-regexpは、単なるSyntaxErrorを超えて、正規表現のベストプラクティスや、Annex Bに記載されているレガシー構文などをチェックしてくれます。 -->
```

## 今後の動向について

Annex Bまわりどうするの〜

## 感想

かんそう
